<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Page - Stuff Stored</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    max-width: 900px;
    margin: 2rem auto;
    background: #f9f9f9;
    color: #222;
    padding: 1rem;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  h1 {
    font-weight: 600;
    font-size: 2rem;
    margin: 0;
    color: #007aff;
  }
  button {
    background-color: #007aff;
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.5rem 1.2rem;
    border-radius: 12px;
    cursor: pointer;
    transition: background-color 0.25s ease;
  }
  button:hover {
    background-color: #005bb5;
  }
  .data-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .data-row {
    background: white;
    padding: 1rem;
    border-radius: 10px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  .data-content {
    display: grid;
    grid-template-columns: max-content 1fr;
    gap: 0.3rem 1rem;
    font-size: 0.9rem;
    white-space: nowrap;
    flex: 1 1 600px;
  }
  .data-content div:first-child {
    font-weight: 700;
    color: #555;
  }
  .delete-btn {
    background: #ff3b30;
    border-radius: 12px;
    font-weight: 600;
    padding: 0.3rem 0.9rem;
    font-size: 0.85rem;
    margin-left: 1rem;
    flex-shrink: 0;
  }
  .delete-btn:hover {
    background: #c1271f;
  }
  /* Confirmation popup overlay */
  #confirmOverlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.25);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #confirmBox {
    background: white;
    border-radius: 15px;
    padding: 1.5rem 2rem;
    width: 90%;
    max-width: 320px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    text-align: center;
    font-size: 1.1rem;
    font-weight: 500;
  }
  #confirmButtons {
    margin-top: 1.5rem;
    display: flex;
    justify-content: space-around;
  }
  #confirmButtons button {
    padding: 0.5rem 1.5rem;
    border-radius: 15px;
    font-weight: 600;
    font-size: 1rem;
  }
  #confirmYes {
    background-color: #007aff;
    color: white;
  }
  #confirmYes:hover {
    background-color: #005bb5;
  }
  #confirmNo {
    background-color: #f0f0f0;
  }
  #confirmNo:hover {
    background-color: #ccc;
  }
</style>
</head>
<body>
<header>
  <h1>Admin Page - Stuff Stored</h1>
  <button id="deleteAllBtn">Delete All Entries</button>
</header>

<div class="data-list" id="dataList">
  <!-- Data rows will appear here -->
</div>

<!-- Confirmation Popup -->
<div id="confirmOverlay">
  <div id="confirmBox">
    <div id="confirmMessage">Are you sure?</div>
    <div id="confirmButtons">
      <button id="confirmYes">Yes</button>
      <button id="confirmNo">No</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyApoNEdlKTIhjYyCTQTjhkdsIotxs3YaKU",
    authDomain: "ip--address-catcher-12.firebaseapp.com",
    databaseURL: "https://ip--address-catcher-12-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ip--address-catcher-12",
    storageBucket: "ip--address-catcher-12.firebasestorage.app",
    messagingSenderId: "1049666257395",
    appId: "1:1049666257395:web:a2e4418ea89ecf59511286",
    measurementId: "G-J30PRNTW1M"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  const collectionRef = collection(db, "userData");

  const dataList = document.getElementById("dataList");
  const deleteAllBtn = document.getElementById("deleteAllBtn");
  const confirmOverlay = document.getElementById("confirmOverlay");
  const confirmMessage = document.getElementById("confirmMessage");
  const confirmYes = document.getElementById("confirmYes");
  const confirmNo = document.getElementById("confirmNo");

  let confirmCallback = null;

  function showConfirm(message, callback) {
    confirmMessage.textContent = message;
    confirmOverlay.style.display = "flex";

    function cleanup() {
      confirmOverlay.style.display = "none";
      confirmYes.removeEventListener("click", yesHandler);
      confirmNo.removeEventListener("click", noHandler);
      confirmCallback = null;
    }

    function yesHandler() {
      cleanup();
      callback();
    }
    function noHandler() {
      cleanup();
    }

    confirmYes.addEventListener("click", yesHandler);
    confirmNo.addEventListener("click", noHandler);
  }

  async function fetchData() {
    dataList.innerHTML = "<p>Loading...</p>";
    try {
      const snapshot = await getDocs(collectionRef);
      renderData(snapshot.docs);
    } catch (error) {
      dataList.innerHTML = `<p>Error loading data: ${error.message}</p>`;
    }
  }

  function renderData(docs) {
    dataList.innerHTML = "";
    if (docs.length === 0) {
      dataList.innerHTML = "<p>No data found.</p>";
      return;
    }

    docs.forEach(docSnap => {
      const data = docSnap.data();
      const id = docSnap.id;

      const row = document.createElement("div");
      row.className = "data-row";

      const content = document.createElement("div");
      content.className = "data-content";

      [
        ["IP Address", data.ip],
        ["Browser", data.userAgent],
        ["Platform", data.platform],
        ["OS", data.os],
        ["Screen Resolution", data.screenRes],
        ["Language", data.language],
        ["Timezone", data.timezone],
        ["Date/Time", data.dateTime ? new Date(data.dateTime).toLocaleString() : "-"],
        ["Referrer", data.referrer]
      ].forEach(([key, val]) => {
        const keyDiv = document.createElement("div");
        keyDiv.textContent = key + ":";
        const valDiv = document.createElement("div");
        valDiv.textContent = val || "-";
        content.appendChild(keyDiv);
        content.appendChild(valDiv);
      });

      row.appendChild(content);

      const delBtn = document.createElement("button");
      delBtn.className = "delete-btn";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        showConfirm("Are you sure you want to delete this entry?", async () => {
          try {
            await deleteDoc(doc(db, "userData", id));
            fetchData();
          } catch (err) {
            alert("Error deleting entry: " + err.message);
          }
        });
      });

      row.appendChild(delBtn);

      dataList.appendChild(row);
    });
  }

  async function deleteAllEntries() {
    try {
      const snapshot = await getDocs(collectionRef);
      if (snapshot.empty) {
        alert("No entries to delete.");
        return;
      }
      const batch = writeBatch(db);
      snapshot.docs.forEach(d => {
        batch.delete(doc(db, "userData", d.id));
      });
      await batch.commit();
      fetchData();
    } catch (err) {
      alert("Error deleting all entries: " + err.message);
    }
  }

  deleteAllBtn.addEventListener("click", () => {
    showConfirm("Are you sure you want to delete ALL entries?", () => {
      deleteAllEntries();
    });
  });

  // Load data on page load
  fetchData();
</script>
</body>
</html>
